:root {
    --bg: #0b1020;
    --panel: #0f1630;
    --panel2: #0c1329;
    --card: #121c3a;
    --card2: #0f1733;
    --line: rgba(255, 255, 255, .08);
    --line2: rgba(255, 255, 255, .12);
    --text: rgba(255, 255, 255, .92);
    --muted: rgba(255, 255, 255, .62);
    --muted2: rgba(255, 255, 255, .42);
    --accent: #4ea1ff;
    --danger: #ff4e4e;
    --ok: #4dffb2;

    --topbar-h: 56px;
    --radius: 14px;
    --radius2: 10px;
    --shadow: 0 12px 30px rgba(0, 0, 0, .35);
    --shadow2: 0 8px 18px rgba(0, 0, 0, .28);
    --gap: 12px;
    --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial;
}

* {
    box-sizing: border-box
}

html, body {
    height: 100%
}

body {
    margin: 0;
    font-family: var(--font);
    background: radial-gradient(1200px 700px at 20% 10%, rgba(78, 161, 255, .15), transparent 55%),
    radial-gradient(900px 500px at 90% 20%, rgba(77, 255, 178, .08), transparent 55%),
    var(--bg);
    color: var(--text);
    overflow: hidden; /* 页面不滚，内部滚 */
}

#app {
    height: 100%;
    display: flex;
    flex-direction: column;
    min-height: 0; /* 关键：允许子 flex 区域产生滚动 */
}

.topbar {
    height: var(--topbar-h);
    flex: 0 0 var(--topbar-h);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    border-bottom: 1px solid var(--line);
    background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
    backdrop-filter: blur(10px);
}

.topbar-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.brand {
    display: flex;
    flex-direction: column;
    gap: 2px
}

.brand-title {
    font-weight: 700;
    letter-spacing: .2px
}

.brand-sub {
    font-size: 12px;
    color: var(--muted)
}

.topbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap
}

.sep {
    width: 1px;
    height: 22px;
    background: var(--line2);
    margin: 0 4px
}

.btn {
    appearance: none;
    border: 1px solid var(--line2);
    background: rgba(255, 255, 255, .03);
    color: var(--text);
    text-decoration: none;
    height: 34px;
    padding: 0 10px;
    border-radius: 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    transition: transform .06s ease, background .15s ease, border-color .15s ease;
}

.btn:hover {
    background: rgba(255, 255, 255, .06);
    border-color: rgba(255, 255, 255, .18)
}

.btn:active {
    transform: translateY(1px)
}

.btn.primary {
    background: rgba(78, 161, 255, .14);
    border-color: rgba(78, 161, 255, .35)
}

.btn.primary:hover {
    background: rgba(78, 161, 255, .2)
}

.btn.danger {
    background: rgba(255, 78, 78, .12);
    border-color: rgba(255, 78, 78, .35)
}

.btn.icon {
    width: 34px;
    padding: 0;
    justify-content: center
}

.btn.small {
    height: 28px;
    padding: 0 8px;
    border-radius: 9px;
    font-size: 12px
}

.layout {
    height: calc(100vh - var(--topbar-h));
    flex: 1;
    display: flex;
    gap: var(--gap);
    padding: var(--gap);
    min-height: 0; /* 关键：内部面板才能滚 */
}

.panel {
    background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow2);
    min-height: 0; /* 关键 */
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.panel.left {
    width: 360px;
    flex: 0 0 360px;
    min-height: 0
}

.panel.right {
    width: 420px;
    flex: 0 0 420px;
    min-height: 0
}

.panel-title {
    padding: 12px 12px 8px;
    font-weight: 700;
    border-bottom: 1px solid var(--line);
}

.panel-footnote {
    padding: 10px 12px;
    font-size: 12px;
    color: var(--muted);
    border-top: 1px solid var(--line);
    background: rgba(0, 0, 0, .12);
}

/* ✅ 滚动容器兼容：.cards 或 #cardsRoot 都能滚 */
.cards,
#cardsRoot {
    flex: 1 1 0;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scroll-behavior: smooth;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
}

.cards::-webkit-scrollbar,
#cardsRoot::-webkit-scrollbar {
    width: 10px
}

.cards::-webkit-scrollbar-thumb,
#cardsRoot::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, .12);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: content-box
}

.cards::-webkit-scrollbar-thumb:hover,
#cardsRoot::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, .18);
    border: 2px solid transparent;
    background-clip: content-box
}

.viewer {
    flex: 1;
    min-width: 0;
    min-height: 0;
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--line);
    background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(0, 0, 0, .12));
    box-shadow: var(--shadow);
    position: relative;
    display: flex;
    flex-direction: column;
}

.viewer-hud {
    position: absolute;
    left: 10px;
    right: 10px;
    top: 10px;
    z-index: 5;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
    pointer-events: none;
}

.hud-left, .hud-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    pointer-events: auto
}

.badge {
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid var(--line2);
    background: rgba(0, 0, 0, .25);
    color: var(--text);
}

.hidden {
    display: none !important
}

.chk {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--line2);
    background: rgba(0, 0, 0, .22);
    font-size: 12px;
    color: var(--muted);
    user-select: none;
}

.chk input {
    accent-color: var(--accent)
}

.three-host {
    flex: 1;
    min-height: 0
}

.code {
    flex: 1;
    min-height: 0;
    width: 100%;
    resize: none;
    outline: none;
    border: none;
    background: transparent;
    color: rgba(255, 255, 255, .92);
    padding: 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12.5px;
    line-height: 1.45;
    overflow: auto;
}

.panel-actions {
    padding: 10px 12px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.card {
    background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(0, 0, 0, .18));
    border: 1px solid var(--line);
    border-radius: var(--radius2);
    overflow: hidden;
}

/* ✅ 聚焦高亮：让用户一眼看出当前聚焦的卡片 */
.card.focused {
    border-color: rgba(78, 161, 255, .55);
    box-shadow: 0 0 0 1px rgba(78, 161, 255, .18), 0 12px 30px rgba(0, 0, 0, .32);
}

.card.focused .card-head {
    background: rgba(78, 161, 255, .12);
    border-bottom-color: rgba(78, 161, 255, .22);
}

.card.focused .badge2 {
    border-color: rgba(78, 161, 255, .28);
    color: rgba(255, 255, 255, .92);
    background: rgba(78, 161, 255, .08);
}

.card.dragging {
    opacity: .75
}

.card-head {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 10px 8px;
    border-bottom: 1px solid var(--line);
    background: rgba(0, 0, 0, .16);
    min-width: 0;
    /* ✅ 嵌套 withBuilder 宽度变窄时：允许换行，避免右侧按钮拥挤 */
    flex-wrap: wrap;
}

.card-title {
    flex: 1 1 auto;
    min-width: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.handle {
    width: 22px;
    height: 22px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--line2);
    background: rgba(255, 255, 255, .03);
    cursor: grab;
    user-select: none;
    flex: 0 0 auto;
}

.title-text {
    font-weight: 700;
    font-size: 13px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
}

.badge2 {
    flex: 0 0 auto;
    font-size: 11px;
    color: var(--muted);
    border: 1px solid var(--line2);
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(0, 0, 0, .18);
}

.card-actions {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-left: 6px;
    /* ✅ 按钮多时放入“更多”菜单 */
    flex-wrap: nowrap;
    overflow: hidden;
    justify-content: flex-end;
    min-width: 0;
}

.card-actions .iconbtn,
.card-actions .btn,
.card-actions .more-wrap {
    flex: 0 0 auto;
    flex-shrink: 0;
}

/* ✅ 子卡片更紧凑：嵌套层级多时减少“按钮拥挤” */
.subcards .card-head{
    gap: 6px;
    padding: 8px 8px 6px;
}
.subcards .handle{
    width: 20px;
    height: 20px;
    border-radius: 6px;
}
.subcards .title-text{
    font-size: 12px;
}
.subcards .iconbtn{
    width: 24px;
    height: 24px;
    border-radius: 8px;
}
.subcards .card-actions{
    gap: 4px;
    margin-left: auto;
}

.iconbtn {
    width: 28px;
    height: 28px;
    border-radius: 9px;
    border: 1px solid var(--line2);
    background: rgba(255, 255, 255, .03);
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background .15s ease, border-color .15s ease;
}

.iconbtn:hover {
    background: rgba(255, 255, 255, .06);
    border-color: rgba(255, 255, 255, .2)
}

.iconbtn.danger {
    border-color: rgba(255, 78, 78, .35);
    background: rgba(255, 78, 78, .08)
}

.iconbtn.danger:hover {
    background: rgba(255, 78, 78, .14)
}

.plane-select {
    height: 24px;
    padding: 0 6px;
    font-size: 12px;
    border-radius: 999px;
    min-width: 84px;
    width: 84px;
    flex: 0 0 auto;
    text-align: center;
    text-align-last: center;
    box-sizing: border-box;
}

.more-wrap {
    position: relative;
    flex: 0 0 auto;
}

.more-wrap.hidden {
    display: none;
}

.more-btn {
    font-weight: 800;
}

.more-menu {
    position: absolute;
    right: 0;
    top: calc(100% + 6px);
    min-width: 160px;
    max-width: 260px;
    background: linear-gradient(180deg, rgba(20, 26, 56, .92), rgba(0, 0, 0, .75));
    border: 1px solid var(--line2);
    border-radius: 12px;
    padding: 6px;
    box-shadow: var(--shadow2);
    display: none;
    z-index: 5;
}

.more-wrap.open .more-menu {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.more-menu .iconbtn,
.more-menu .btn {
    width: 100%;
    justify-content: flex-start;
}

.card-body {
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.row {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
}

.label {
    width: 98px;
    flex: 0 0 98px;
    font-size: 12px;
    color: var(--muted);
}

.input {
    flex: 1 1 auto;
    min-width: 0;
    height: 30px;
    padding: 0 10px;
    border-radius: 10px;
    border: 1px solid var(--line2);
    background: rgba(0, 0, 0, .16);
    color: var(--text);
    outline: none;
}

.input:focus {
    border-color: rgba(78, 161, 255, .45);
    box-shadow: 0 0 0 3px rgba(78, 161, 255, .12)
}

select.input {
    padding-right: 30px
}

.mini {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.mini input.input {
    width: 110px;
    flex: 0 0 110px
}

.pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--line2);
    background: rgba(0, 0, 0, .18);
    color: var(--muted);
    font-size: 12px;
}

.subblock {
    border: 1px dashed rgba(255, 255, 255, .14);
    border-radius: 12px;
    padding: 10px;
    background: rgba(0, 0, 0, .1);
}

.subblock-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
    /* ✅ 嵌套时标题与按钮分两行，避免一行挤爆 */
    flex-wrap: wrap;
}

.subblock-title {
    font-weight: 700;
    font-size: 12px;
    color: rgba(255, 255, 255, .86);
    flex: 1 1 100%;
}

/* ✅ 子Builder操作按钮：占满整行并可换行 */
.subblock-head .mini{
    flex: 1 1 100%;
    justify-content: flex-start;
}

/* ✅ 子Builder 内的按钮更紧凑（嵌套多层时） */
.subblock-head .mini{ gap: 6px; }
.subblock-head .mini .btn.small{
    height: 26px;
    padding: 0 6px;
    border-radius: 9px;
    font-size: 12px;
}

.subcards {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Modal */
.modal-mask {
    position: fixed;
    inset: 0;
    background: rgba(12, 14, 24, .52);
    z-index: 50;
    backdrop-filter: blur(14px) saturate(1.2);
    -webkit-backdrop-filter: blur(14px) saturate(1.2);
}



.modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: min(860px, 92vw);
    height: min(560px, 80vh);
    background: linear-gradient(180deg, rgba(20, 26, 56, .72), rgba(0, 0, 0, .45));
    border: 1px solid var(--line2);
    border-radius: 18px;
    box-shadow: var(--shadow);
    z-index: 60;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
}


.modal-head {
    padding: 12px 12px 10px;
    border-bottom: 1px solid var(--line);

    /* 用 grid 固定布局：左标题 / 中间搜索 / 右按钮 */
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 10px;
}

#btnCloseModal {
    grid-column: 3;
    justify-self: end;
}

/* 标题固定左侧 */
.modal-title {
    grid-column: 1;
    justify-self: start;
}

/* 搜索框：居中 + 更矮（不会比卡片高） */
#cardSearch {
    grid-column: 2;
    justify-self: center;

    height: 26px;
    line-height: 26px;
    padding: 0 10px;
    font-size: 13px;

    border-radius: 12px;
}

/* 如果你还有其它 modal 内输入框想保持默认，不影响 */
.modal-body {
    flex: 1;
    min-height: 0;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* ✅ 快捷键设置：列表内容可滚动，避免看不到下面 */
#hkModal .modal-body{
    overflow: hidden;
}
#hkList{
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
}
#hkList::-webkit-scrollbar{ width: 10px; }
#hkList::-webkit-scrollbar-thumb{
    background: rgba(255, 255, 255, .12);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: content-box;
}
#hkList::-webkit-scrollbar-thumb:hover{
    background: rgba(255, 255, 255, .18);
    border: 2px solid transparent;
    background-clip: content-box;
}

/* ✅ 快捷键行在窄宽度下换行 */
.hk-row{ flex-wrap: wrap; align-items: flex-start; }
.hk-btns{ flex-wrap: wrap; }

.modal-foot {
    padding: 10px 12px;
    border-top: 1px solid var(--line);
    display: flex;
    justify-content: flex-end;
}

.picker {
    flex: 1;
    min-height: 0;
    overflow: auto;
    display: grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap: 10px;
    padding-right: 4px;
}

.pickitem {
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 10px 10px;
    cursor: pointer;
    background: rgba(0, 0, 0, .15);
    transition: transform .06s ease, border-color .15s ease, background .15s ease;
}

.pickitem:hover {
    transform: translateY(-1px);
    background: rgba(255, 255, 255, .04);
    border-color: rgba(255, 255, 255, .18);
}

.pickitem .t {
    font-weight: 800;
    margin-bottom: 4px
}

.pickitem .d {
    font-size: 12px;
    color: var(--muted)
}

@media (max-width: 1100px) {
    .panel.left {
        width: 320px;
        flex: 0 0 320px
    }

    .panel.right {
        width: 380px;
        flex: 0 0 380px
    }
}

@media (max-width: 980px) {
    .layout {
        flex-direction: column
    }

    .panel.left, .panel.right {
        width: auto;
        flex: 0 0 auto;
        height: 34vh
    }

    .viewer {
        height: 42vh
    }
}

@media (max-width: 520px) {
    #cardSearch {
        flex: 1 1 auto;
        width: auto;
        max-width: none;
    }
}
/* =============================
   FIX: 卡片过多时不要被压缩，启用滚动
   ============================= */

/* 1) 主列表容器确保可滚动（你可能是 .cards 或 #cardsRoot） */
.cards,
#cardsRoot{
    min-height: 0 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
}

/* 2) 关键：card 作为 flex item 不允许 shrink，否则会被“挤压变瘦” */
.cards > .card,
#cardsRoot > .card,
.subcards > .card{
    flex: 0 0 auto !important;   /* 不增长不压缩 */
}

/* 3) withBuilder / Fourier 内部的子卡片区域也启用滚动（避免内部也挤压） */
.subblock{
    min-height: 0 !important;
}

.subcards{
    min-height: 0 !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    max-height: min(360px, 42vh); /* 你可以调，比如 520px 或 50vh */
    padding-right: 4px;
}

/* 4) 子卡片滚动条样式（可选） */
.subcards::-webkit-scrollbar{ width: 10px; }
.subcards::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.12);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: content-box;
}
.subcards::-webkit-scrollbar-thumb:hover{
    background: rgba(255,255,255,.18);
    border: 2px solid transparent;
    background-clip: content-box;
}
.three-host { touch-action: none; }

/* =============================
   Hotkeys Modal（快捷键设置）
   - 解决：没有滚动条看不到下面内容
   - 解决：窄屏时一行挤爆
   ============================= */

/* 热键列表滚动：modal 本身 overflow:hidden，所以把滚动放在 hkList */
#hkModal .modal-body{ overflow: hidden; }
#hkList{
    flex: 1 1 0;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
}

#hkList::-webkit-scrollbar{ width: 10px; }
#hkList::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.12);
    border-radius: 10px;
    border: 2px solid transparent;
    background-clip: content-box;
}
#hkList::-webkit-scrollbar-thumb:hover{
    background: rgba(255,255,255,.18);
    border: 2px solid transparent;
    background-clip: content-box;
}

.hk-list{ display:flex; flex-direction:column; gap:10px; }
.hk-section{ border:1px solid var(--line); border-radius:14px; padding:10px; background:rgba(0,0,0,.10); }
.hk-section-title{ font-weight:800; font-size:12px; color:rgba(255,255,255,.86); margin-bottom:8px; }
.hk-row{ display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:rgba(0,0,0,.12); flex-wrap:wrap; }
.hk-name{ flex:1 1 240px; min-width:0; }
.hk-name .t{ font-weight:800; }
.hk-name .d{ font-size:12px; color:var(--muted); }
.hk-key{ flex:0 0 auto; min-width:90px; text-align:center; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line2); background:rgba(255,255,255,.04); color:rgba(255,255,255,.92); }
.hk-key.empty{ color:var(--muted2); background:rgba(0,0,0,.12); }
.hk-btns{ display:flex; gap:8px; flex:0 0 auto; flex-wrap:wrap; }

/* 添加卡片 picker 内的快捷键提示 */
.pickitem{ position:relative; }
.hkbad{ position:absolute; right:10px; top:10px; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line2); background:rgba(0,0,0,.18); color:var(--muted); }
.sethk{ position:absolute; right:10px; bottom:10px; width:30px; height:30px; border-radius:10px; border:1px solid var(--line2); background:rgba(255,255,255,.03); color:var(--text); cursor:pointer; }
.sethk:hover{ background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.20); }


/* -------------------------
   Modal stacking & frosted polish
   ------------------------- */
/* 让快捷键窗口永远盖在添加卡片窗口之上（即使两者都打开） */
#modalMask{ z-index: 50; }
#modal{ z-index: 60; }
#hkMask{ z-index: 70; }
#hkModal{ z-index: 80; }

/* 当快捷键弹窗打开时，把添加卡片弹窗置为底层磨砂，避免叠窗可读性差 */
.modal.under{
    filter: blur(10px);
    opacity: .22;
    transform: translate(-50%, -50%) scale(.98);
    pointer-events: none;
}
.modal-mask.under{
    display: none !important;
}
